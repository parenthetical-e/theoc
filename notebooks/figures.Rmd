---
title: "Paper figures - Balanced oscillations improve information flow (2020 edition)"
output: html_notebook
---

# Libraries and helpers
```{r helper_fns, echo=FALSE, fig.width=6, fig.height=4, echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(grid)
library(gridExtra)
library(plyr)
library(readr)
library(dplyr)
library(png)
library(bspec)
library(psd)
library(tidyr)
library(patchwork)
library(scales)
library(ggpubr)
library(cowplot)
library(latex2exp)
# library(NNTbiomarker)
# library(bspec)

load.data1 <- function(path, type, stim_rates, qs, num_pops, pns){
  df <- NULL
  for(r_s in stim_rates){
    for(g in gs){
      for(n in num_pops){
        for(q in qs){
          try({
            name <- paste("stim_rate", as.character(r_s), 
                          "_g", as.character(g),
                          "_num_pop", as.character(n),
                          "_q", as.character(q),
                          "_", as.character(type), 
                          ".csv", sep="")
            di <- read.csv(paste(path, name, sep=""))
            di["stim_rate"] <- rep(r_s, nrow(di))
            di["g"] <- rep(g, nrow(di))
            di["num_pop"] <- rep(n, nrow(di))
            di["q"] <- rep(q, nrow(di))
            di["trial"] <- 1:nrow(di)
            df <- rbind(df, di)  
          })  
        }
      }
    }
  }
  df
}
load.data2 <- function(path, type, fs){
  df <- NULL
  for(f in fs){
    try({
      # stim_rate-_2_g-11_num_pop-10_q-0.0_rate
      name <- paste("f", as.character(f), 
                    "_", as.character(type), 
                    ".csv", sep="")
      di <- read.csv(paste(path, name, sep=""))
      di["f"] <- rep(f, nrow(di))
      di["trial"] <- 1:nrow(di)
      df <- rbind(df, di)  
    })  
  }
  df
}
load.data3 <- function(path, type, osc_rates){
  df <- NULL
  for(o_r in osc_rates){
    try({
      # stim_rate-_2_g-11_num_pop-10_q-0.0_rate
      name <- paste("osc_rate", as.character(o_r), 
                    "_", as.character(type), 
                    ".csv", sep="")
      di <- read.csv(paste(path, name, sep=""))
      di["osc_rate"] <- rep(o_r, nrow(di))
      di["trial"] <- 1:nrow(di)
      df <- rbind(df, di)  
    })  
  }
  df
}
load.data4 <- function(path, type, ms){
  df <- NULL
  for(m in ms){
    try({
      # stim_rate-_2_g-11_num_pop-10_q-0.0_rate
      name <- paste("m", as.character(m), 
                    "_", as.character(type), 
                    ".csv", sep="")
      di <- read.csv(paste(path, name, sep=""))
      di["m"] <- rep(m, nrow(di))
      di["trial"] <- 1:nrow(di)
      df <- rbind(df, di)  
    })  
  }
  df
}
load.data5 <- function(path, type, num_backgrounds){
  df <- NULL
  for(n_b in num_backgrounds){
    try({
      # stim_rate-_2_g-11_num_pop-10_q-0.0_rate
      name <- paste("num_background", as.character(n_b), 
                    "_", as.character(type), 
                    ".csv", sep="")
      di <- read.csv(paste(path, name, sep=""))
      di["num_background"] <- rep(n_b, nrow(di))
      di["trial"] <- 1:nrow(di)
      df <- rbind(df, di)  
    })  
  }
  df
}
load.data6 <- function(path, type, num_pops){
  df <- NULL
  for(n_p in num_pops){
    try({
      # stim_rate-_2_g-11_num_pop-10_q-0.0_rate
      name <- paste("num_pop", as.character(n_p), 
                    "_", as.character(type), 
                    ".csv", sep="")
      di <- read.csv(paste(path, name, sep=""))
      di["num_pop"] <- rep(n_p, nrow(di))
      di["trial"] <- 1:nrow(di)
      df <- rbind(df, di)  
    })  
  }
  df
}
load.data7 <- function(path, type, stim_rates, qs, num_pops, osc_rates, pns){
  df <- NULL
  for(r_s in stim_rates){
    for(g in gs){
      for(n in num_pops){
        for(q in qs){
          for(osr in osc_rates) {
            try({
              name <- paste("stim_rate", as.character(r_s), 
                            "_g", as.character(g),
                            "_num_pop", as.character(n),
                            "_q", as.character(q),
                            "_osc_rate", as.character(osr),
                            "_", as.character(type), 
                            ".csv", sep="")
              di <- read.csv(paste(path, name, sep=""))
              di["stim_rate"] <- rep(r_s, nrow(di))
              di["osc_rate"] <- rep(osr, nrow(di))
              di["g"] <- rep(g, nrow(di))
              di["num_pop"] <- rep(n, nrow(di))
              di["q"] <- rep(q, nrow(di))
              di["trial"] <- 1:nrow(di)
              df <- rbind(df, di)  
            })  
          }
        }
      }
    }
  }
  df
}
```

# Load data
## Exp - the main results 
```{r load1, message=FALSE, warning=FALSE, error=FALSE}
path <- "~/Code/theoc/data/"

# -- num_pop search-----------------------------------------------------------  
stim_rates <- c(10)
gs <- c(1, 2, 3, 4, 5, 6, 7, 8)
num_pops <- c(10, 20, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240, 20480, 40960)
qs <- c("0.5")

exp_path <- paste(path, "/exp15/", sep="")
mi_exp15 <- load.data1(exp_path, "MI", stim_rates, qs, num_pops, qs)
dmi_exp15 <- load.data1(exp_path, "dMI", stim_rates, qs, num_pops, qs)
h_exp15 <- load.data1(exp_path, "H", stim_rates, qs, num_pops, qs)
pac_exp15 <- load.data1(exp_path, "PAC", stim_rates, qs, num_pops, qs)
pow_exp15 <- load.data1(exp_path, "power", stim_rates, qs, num_pops, qs)

# -- num_pop = 10240  -----------------------------------------------------
# stim_rate
stim_rates <- c(5, 10, 15, 20, 25, 30)
gs <- c(1, 2, 3, 4, 5, 6, 7, 8)
num_pops <- c(10240)
osc_rates <- c(2)
qs <- c("0.05", "0.25", "0.5", "0.75", "1.0")
exp_path <- paste(path, "/exp18/", sep="")
mi_exp18 <- load.data7(exp_path, "MI", stim_rates, qs, num_pops, osc_rates, qs)
dmi_exp18 <- load.data7(exp_path, "dMI", stim_rates, qs, num_pops, osc_rates, qs)
h_exp18 <- load.data7(exp_path, "H", stim_rates, qs, num_pops, osc_rates, qs)
pac_exp18 <- load.data7(exp_path, "PAC", stim_rates, qs, num_pops, osc_rates, qs)
pow_exp18 <- load.data7(exp_path, "power", stim_rates, qs, num_pops, osc_rates, qs)

# osc_rate
stim_rates <- c(10)
gs <- c(1, 2, 3, 4, 5, 6, 7, 8)
num_pops <- c(10240)
osc_rates <- c(2, 5, 10, 12, 15, 20)
qs <- c("0.05", "0.25", "0.5", "0.75", "1.0")
exp_path <- paste(path, "/exp19/", sep="")
mi_exp19 <- load.data7(exp_path, "MI", stim_rates, qs, num_pops, osc_rates, qs)
dmi_exp19 <- load.data7(exp_path, "dMI", stim_rates, qs, num_pops, osc_rates, qs)
h_exp19 <- load.data7(exp_path, "H", stim_rates, qs, num_pops, osc_rates, qs)
pac_exp19 <- load.data7(exp_path, "PAC", stim_rates, qs, num_pops, osc_rates, qs)
pow_exp19 <- load.data7(exp_path, "power", stim_rates, qs, num_pops, osc_rates, qs)

# stim_rate / osc_rate
stim_rates <- c(5, 10, 12, 15)
gs <- c(1, 2, 3, 4, 5, 6, 7, 8)
num_pops <- c(10240)
osc_rates <- c(2, 5, 10, 12)
qs <- c("0.05", "0.25", "0.5", "0.75", "1.0")
exp_path <- paste(path, "/exp20/", sep="")
mi_exp20 <- load.data7(exp_path, "MI", stim_rates, qs, num_pops, osc_rates, qs)
dmi_exp20 <- load.data7(exp_path, "dMI", stim_rates, qs, num_pops, osc_rates, qs)
h_exp20 <- load.data7(exp_path, "H", stim_rates, qs, num_pops, osc_rates, qs)
pac_exp20 <- load.data7(exp_path, "PAC", stim_rates, qs, num_pops, osc_rates, qs)
pow_exp20 <- load.data7(exp_path, "power", stim_rates, qs, num_pops, osc_rates, qs)

# -- num_pop = 40 -----------------------------------------------------
# stim_rate
stim_rates <- c(5, 10, 15, 20, 25, 30)
gs <- c(1, 2, 3, 4, 5, 6, 7, 8)
num_pops <- c(40)
osc_rates <- c(2)
qs <- c("0.05", "0.25", "0.5", "0.75", "1.0")
exp_path <- paste(path, "/exp21/", sep="")
mi_exp21 <- load.data7(exp_path, "MI", stim_rates, qs, num_pops, osc_rates, qs)
dmi_exp21 <- load.data7(exp_path, "dMI", stim_rates, qs, num_pops, osc_rates, qs)
h_exp21 <- load.data7(exp_path, "H", stim_rates, qs, num_pops, osc_rates, qs)
pac_exp21 <- load.data7(exp_path, "PAC", stim_rates, qs, num_pops, osc_rates, qs)
pow_exp21 <- load.data7(exp_path, "power", stim_rates, qs, num_pops, osc_rates, qs)

# osc_rate
stim_rates <- c(10)
gs <- c(1, 2, 3, 4, 5, 6, 7, 8)
num_pops <- c(40)
osc_rates <- c(2, 5, 10, 12, 15, 20)
qs <- c("0.05", "0.25", "0.5", "0.75", "1.0")
exp_path <- paste(path, "/exp22/", sep="")
mi_exp22 <- load.data7(exp_path, "MI", stim_rates, qs, num_pops, osc_rates, qs)
dmi_exp22 <- load.data7(exp_path, "dMI", stim_rates, qs, num_pops, osc_rates, qs)
h_exp22 <- load.data7(exp_path, "H", stim_rates, qs, num_pops, osc_rates, qs)
pac_exp22 <- load.data7(exp_path, "PAC", stim_rates, qs, num_pops, osc_rates, qs)
pow_exp22 <- load.data7(exp_path, "power", stim_rates, qs, num_pops, osc_rates, qs)

# stim_rate / osc_rate
stim_rates <- c(5, 10, 12, 15)
gs <- c(1, 2, 3, 4, 5, 6, 7, 8)
num_pops <- c(40)
osc_rates <- c(2, 5, 10, 12)
qs <- c("0.05", "0.25", "0.5", "0.75", "1.0")
exp_path <- paste(path, "/exp23/", sep="")
mi_exp23 <- load.data7(exp_path, "MI", stim_rates, qs, num_pops, osc_rates, qs)
dmi_exp23 <- load.data7(exp_path, "dMI", stim_rates, qs, num_pops, osc_rates, qs)
h_exp23 <- load.data7(exp_path, "H", stim_rates, qs, num_pops, osc_rates, qs)
pac_exp23 <- load.data7(exp_path, "PAC", stim_rates, qs, num_pops, osc_rates, qs)
pow_exp23 <- load.data7(exp_path, "power", stim_rates, qs, num_pops, osc_rates, qs)
```

## Exp - control experiments
```{r load26, message=FALSE, warning=FALSE, error=FALSE}
path <- "~/Code/theoc/data/"

# exp9
fs <- c(4, 6, 8, 12, 20, 30)
exp_path <- paste(path, "/exp9/", sep="")
mi_exp9 <- load.data2(exp_path, "MI", fs)
dmi_exp9 <- load.data2(exp_path, "dMI", fs)
h_exp9 <- load.data2(exp_path, "H", fs)

# exp10
osc_rates <- c(2, 3, 4, 6, 8)
exp_path <- paste(path, "/exp10/", sep="")
mi_exp10 <- load.data3(exp_path, "MI", osc_rates)
dmi_exp10 <- load.data3(exp_path, "dMI", osc_rates)
h_exp10 <- load.data3(exp_path, "H", osc_rates)

# exp11
ms <- c(5, 10, 20)
exp_path <- paste(path, "/exp11/", sep="")
mi_exp11 <- load.data4(exp_path, "MI", ms)
dmi_exp11 <- load.data4(exp_path, "dMI", ms)
h_exp11 <- load.data4(exp_path, "H", ms)

# exp12
num_backgrounds <- c(5, 10, 15, 20, 25)
exp_path <- paste(path, "/exp12/", sep="")
mi_exp12 <- load.data5(exp_path, "MI", num_backgrounds)
dmi_exp12 <- load.data5(exp_path, "dMI", num_backgrounds)
h_exp12 <- load.data5(exp_path, "H", num_backgrounds)

# exp6
num_pops <- c(10, 20, 40, 80, 160, 320, 640, 1280)
exp_path <- paste(path, "/exp6/", sep="")
mi_exp6 <- load.data6(exp_path, "MI", num_pops)
dmi_exp6 <- load.data6(exp_path, "dMI", num_pops)
h_exp6 <- load.data6(exp_path, "H", num_pops)
```

# Figure - FI
```{r, fig.width=0.8, fig.height=1.7, echo=FALSE, warning=FALSE, message=FALSE}
phi1 <- function(x) {
  30 / (1 + exp(-.2*x + 5))
}

phi2 <- function(x, m, b) {
  x <- x - b
  x[x <= 0] <- 0
  x <- x * m
}

input = -20:40
fi = data.frame(
  input=input,
  ref=phi2(input, 1, 0), 
  E=phi2(input+10, 1, 0), 
  I=phi2(input-10, 1, 0), 
  EI=phi2(input*1.5, 1, 0),
  II=phi2((input/1.5)-10, 1, 0))

fi %>% 
  gather(model, fi, E:II) -> fi

fi$model <- factor(fi$model, levels=c("EI", "E", "I", "II"))

fi %>% 
  filter(model != "ref") %>% 
  ggplot(aes(x=input, y=fi)) +
  geom_line() +
  geom_line(aes(x=input, y=ref), color="black", linetype = 2) +
  facet_grid(model~.) +
  labs(x="Input", y="Output", title="Neural arithmetic") +
  theme_classic2() +
  theme(plot.title = element_text(size = 7, hjust=1, face = "bold")) +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(strip.text.y = element_text(face = "bold", angle = 0)) ->
  p1

p1
ggsave("figures/arithmetic.pdf", dpi=600)
```
# Figure - Examples
```{r, fig.width=3, fig.height=5.4, echo=FALSE, warning=FALSE, message=FALSE}
examples <- read_csv("../data/examples.csv")

# S
examples %>% 
  ggplot(aes(x=times, y=stim_ref)) +
  geom_line(color="darkgrey", size=1.1) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits=c(0, 1)) +
  theme_classic2() + 
  labs(x="", y="Norm. rate", tag="a.", title="Stimulus") + 
  theme(plot.title = element_text(size = 9, face = "bold")) ->
p4

examples %>% 
  select(stim_ref) %>% 
 welchPSD(seglength=1000) -> spec
spec <- data.frame(frequency=spec$frequency*1000, power=spec$power)
spec %>% 
  filter(frequency < 25) %>% 
ggplot(aes(x=frequency, y=log10(power))) +
  geom_line(size=0.8, color="darkgrey") +
  labs(x="", y="Power", tag="h.") +
  lims(y=c(-3,2)) +
  theme_classic2() +
  theme(plot.title = element_text(size = 9, hjust=1, face = "bold")) -> s4

# O
examples %>% 
  ggplot(aes(x=times, y=osc_p)) +
  geom_line(aes(x=times, y=osc_ref), color="darkgrey") +
  geom_line(size=1.2) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits=c(0, 1)) +
  theme_classic2() + 
  labs(x="", y="Norm. rate", tag="b.", title="Pacemaker (O)") +
  theme(plot.title = element_text(size = 9, face = "bold")) ->
p5

examples %>% 
  select(osc_p) %>% 
 welchPSD(seglength=1000) -> spec
spec <- data.frame(frequency=spec$frequency*1000, power=spec$power)
spec %>% 
  filter(frequency < 25) %>% 
ggplot(aes(x=frequency, y=log10(power))) +
  geom_line(size=0.8) +
  labs(x="", y="Power", tag="i.") +
  lims(y=c(-3,2.1)) +
  theme_classic2() -> s5


# S
examples %>% 
  ggplot(aes(x=times, y=stim_p)) +
  geom_line() +
  # geom_line(aes(x=times, y=stim_ref), color="darkgrey", size=1.1) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits=c(0, 1)) +
  theme_classic2() + 
  labs(x="", y="Norm. rate", tag="c.",  title="Unmodulated (S)") +
  theme(plot.title = element_text(size = 9, face = "bold")) ->
p9

examples %>% 
  select(stim_p) %>% 
 welchPSD(seglength=1000) -> spec
spec <- data.frame(frequency=spec$frequency*1000, power=spec$power)
spec %>% 
  filter(frequency < 25) %>% 
ggplot(aes(x=frequency, y=log10(power))) +
  geom_line(size=0.8, color="black") +
  labs(x="", y="Power", tag="j.") +
  lims(y=c(-3,2)) +
  theme_classic2() -> s9

# EI
examples %>% 
  ggplot(aes(x=times, y=mult_p)) +
  geom_line() +
  # geom_line(aes(x=times, y=stim_ref), color="darkgrey", size=1.1) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits=c(0, 1)) +
  theme_classic2() + 
  labs(x="", y="Norm. rate", tag="e.", title="Multiplicative (EI)") +
  theme(plot.title = element_text(size = 9, face = "bold")) -> 
p6

examples %>% 
  select(mult_p) %>% 
 welchPSD(seglength=1000) -> spec
spec <- data.frame(frequency=spec$frequency*1000, power=spec$power)
spec %>% 
  filter(frequency < 25) %>% 
ggplot(aes(x=frequency, y=log10(power))) +
  geom_line(size=0.8, color="black") +
  labs(x="", y="Power", tag="l.") +
  lims(y=c(-3,2)) +
  theme_classic2() -> s6

# E
examples %>% 
  ggplot(aes(x=times, y=add_p)) +
  geom_line() +
  # geom_line(aes(x=times, y=stim_ref), color="darkgrey", size=1.1) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits=c(0, 1)) +
  theme_classic2() + 
  labs(x="", y="Norm. rate", tag="d.", title="Additive (E)") +
  theme(plot.title = element_text(size = 9, face = "bold")) ->
p7

examples %>% 
  select(add_p) %>% 
 welchPSD(seglength=1000) -> spec
spec <- data.frame(frequency=spec$frequency*1000, power=spec$power)
spec %>% 
  filter(frequency < 25) %>% 
ggplot(aes(x=frequency, y=log10(power))) +
  geom_line(size=0.8, color="black") +
  labs(x="", y="Power", tag="k.") +
  lims(y=c(-3,2)) +
  theme_classic2() -> s7


# I
examples %>% 
  ggplot(aes(x=times, y=sub_p)) +
  geom_line() +
  # geom_line(aes(x=times, y=stim_ref), color="darkgrey", size=1.2) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits=c(0, 1)) +
  theme_classic2() + 
  labs(x="Time", y="Norm. rate", tag="f.", title="Subtractive (I)") +
  theme(plot.title = element_text(size = 9, face = "bold")) ->
p8

examples %>% 
  select(sub_p) %>% 
 welchPSD(seglength=1000) -> spec
spec <- data.frame(frequency=spec$frequency*1000, power=spec$power)
spec %>% 
  filter(frequency < 25) %>% 
ggplot(aes(x=frequency, y=log10(power))) +
  geom_line(size=0.8, color="black") +
  labs(x="Frequency.", y="Power", tag="m.") +
  lims(y=c(-3,2)) +
  theme_classic2() -> s8

# II
examples %>% 
  ggplot(aes(x=times, y=div_sub_p)) +
  geom_line() +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits=c(0, 1)) +
  labs(x="Time", y="Norm. rate", tag="g.", title="Subtractive/divisive (II)") +
  theme_classic2() + 
  theme(plot.title = element_text(size = 9, face = "bold")) ->
p10

examples %>% 
  select(div_sub_p) %>% 
 welchPSD(seglength=1000) -> spec
spec <- data.frame(frequency=spec$frequency*1000, power=spec$power)
spec %>% 
  filter(frequency < 25) %>% 
ggplot(aes(x=frequency, y=log10(power))) +
  geom_line(size=0.8, color="black") +
  labs(x="Frequency.", y="Power", tag="n.") +
  lims(y=c(-3,2)) +
  theme_classic2() -> s10

# --------------------------------------------------------------------  
((p4 / p5 / p9 / p7 / p6 / p8 / p10) | (s4 / s5 / s9 / s7 / s6 / s8 / s10)) +
  plot_layout(width = c(0.75, 0.25)) +
  # plot_annotation(tag_levels = 'a', tag_suffix = ".")
ggsave("figures/example.pdf", dpi=600, width=2*3, height=2*5.4)
```

# Figure - Entropy and probability
```{r}
# arrow 
arrow <- data.frame(x=0, xend=1, y=0.5, yend=0.5)
arrow %>% 
ggplot(aes(x=x, y=y, xend=xend, yend = yend)) +
  geom_segment(
    lineend = "butt", linejoin = "mitre",
    size = 1, arrow = arrow(length = unit(0.2, "inches"))
  ) +
  labs(x="", y="") +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(axis.text = element_blank()) +
  theme(axis.text = element_blank()) +
  theme(axis.ticks = element_blank()) +
  theme(strip.text = element_blank()) +
  theme(axis.line = element_blank()) -> a1
```

```{r, fig.width=4, fig.height=1, echo=FALSE, warning=FALSE, message=FALSE}
examples <- read_csv("../data/examples.csv")
example_dists <- read_csv("../data/example_dists.csv")


examples %>% 
  ggplot(aes(x=times, y=stim_ref)) +
  geom_line(color="darkgrey", size=1.1) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits=c(0, 1.1)) +
  geom_hline(yintercept=1, color="grey", size=0.2) +
  geom_hline(yintercept=0.9, color="grey", size=0.2) +
  geom_hline(yintercept=0.8, color="grey", size=0.2) +
  geom_hline(yintercept=0.7, color="grey", size=0.2) +
  geom_hline(yintercept=0.6, color="grey", size=0.2) +
  geom_hline(yintercept=0.5, color="grey", size=0.2) +
  geom_hline(yintercept=0.4, color="grey", size=0.2) +
  geom_hline(yintercept=0.3, color="grey", size=0.2) +
  geom_hline(yintercept=0.2, color="grey", size=0.2) +
  geom_hline(yintercept=0.1, color="grey", size=0.2) +
  annotate("text", y=1.1, x=5, label="m") +
  labs(x="Time", y="Norm. rate", tag="a.", title="Discretize into m bins") +
  theme_classic2() + 
  # theme(axis.title.y=element_text(angle = 0, vjust = 0.5)) +
  theme(plot.title = element_text(size = 9, face = "bold")) ->
p1

del <- -0.5
example_dists %>% 
  ggplot(aes(x=m, y=stim_ref)) +
  geom_bar(fill="darkgrey", alpha=0.6, stat="identity") +
  scale_x_continuous(breaks=0:9, labels=1:10) +
  geom_vline(xintercept=0+del, color="grey", size=0.2) +
  geom_vline(xintercept=1+del, color="grey", size=0.2) +
  geom_vline(xintercept=2+del, color="grey", size=0.2) +
  geom_vline(xintercept=3+del, color="grey", size=0.2) +
  geom_vline(xintercept=4+del, color="grey", size=0.2) +
  geom_vline(xintercept=5+del, color="grey", size=0.2) +
  geom_vline(xintercept=6+del, color="grey", size=0.2) +
  geom_vline(xintercept=7+del, color="grey", size=0.2) +
  geom_vline(xintercept=8+del, color="grey", size=0.2) +
  geom_vline(xintercept=9+del, color="grey", size=0.2) +
  geom_vline(xintercept=10+del, color="grey", size=0.2) +
  labs(y="Probability", x="m", tag="b.", title="Estimate m probabilities") +
  lims(y=c(0,1)) +
  theme_classic2() +
  theme(plot.title = element_text(size = 9, face = "bold")) -> 
  p2


# ----------------------------------------------------
## Build
p1 + a1 + p2 + plot_layout(widths = c(0.65, 0.1, 0.25))
ggsave("figures/entropy.pdf", dpi=600)
```

# Figure - Dists
```{r, fig.width=1.4, fig.height=4.2, echo=FALSE, warning=FALSE, message=FALSE}
example_dists <- read_csv("../data/example_dists.csv")

example_dists %>% 
  ggplot(aes(x=m, y=stim_p)) +
  geom_bar(stat="identity", alpha=1) +
  geom_bar(aes(x=m, y=stim_ref), fill="darkgrey", alpha=0.6, stat="identity") +
  scale_x_continuous(breaks=0:9, labels=1:10) +
  labs(y="", x="", tag="a.", title="Estimating mutual\ninformation") +
  lims(y=c(0,1)) +
  theme_classic2() + 
  theme(plot.title = element_text(size = 9, face = "bold")) -> p0

example_dists %>% 
  ggplot(aes(x=m, y=mult_p)) +
  geom_bar(stat="identity", alpha=1) +
  geom_bar(aes(x=m, y=stim_ref), fill="darkgrey", alpha=0.6, stat="identity") +
  scale_x_continuous(breaks=0:9, labels=1:10) +
  labs(y="", x="", tag="b.") +
  lims(y=c(0,1)) +
  theme_classic2() + 
  theme(plot.title = element_text(size = 7, hjust=1, face = "bold")) -> p1

example_dists %>% 
  ggplot(aes(x=m, y=add_p)) +
  geom_bar(stat="identity", alpha=1) +
  geom_bar(aes(x=m, y=stim_ref), fill="darkgrey", alpha=0.6, stat="identity") +
  scale_x_continuous(breaks=0:9, labels=1:10) +
  labs(y="", x="", tag="c.") +
  lims(y=c(0,1)) +
  theme_classic2() -> p2

example_dists %>% 
  ggplot(aes(x=m, y=sub_p)) +
  geom_bar(aes(x=m, y=stim_ref), fill="darkgrey", alpha=0.6, stat="identity") +
  geom_bar(stat="identity", alpha=1) +
  scale_x_continuous(breaks=0:9, labels=1:10) +
  labs(y="", x="", tag="d.") +
  lims(y=c(0,1)) +
  theme_classic2() -> p3

example_dists %>% 
  ggplot(aes(x=m, y=div_sub_p)) +
  geom_bar(stat="identity", alpha=1) +
  geom_bar(aes(x=m, y=stim_ref), fill="darkgrey", alpha=0.6, stat="identity") +
  scale_x_continuous(breaks=0:9, labels=1:10) +
  labs(y="", x="m", tag="e.") +
  lims(y=c(0,1)) +
  theme_classic2() + 
  theme(plot.title = element_text(size = 7, hjust=1, face = "bold")) -> p4

y_label <- as_ggplot(text_grob("Probability", hjust=0, rot = 90))
p0_label <- as_ggplot(text_grob("S", hjust=1, face="bold"))
p1_label <- as_ggplot(text_grob("EI", hjust=1, face="bold"))
p2_label <- as_ggplot(text_grob("E", hjust=1, face="bold"))
p3_label <- as_ggplot(text_grob("I", hjust=1, face="bold"))
p4_label <- as_ggplot(text_grob("II", hjust=1, face="bold"))

b0 <- p0 + p0_label + plot_layout(widths = c(0.8, 0.2))
b1 <- p1 + p1_label + plot_layout(widths = c(0.8, 0.2))
b2 <- p2 + p2_label + plot_layout(widths = c(0.8, 0.2))
b3 <- p3 + p3_label + plot_layout(widths = c(0.8, 0.2))
b4 <- p4 + p4_label + plot_layout(widths = c(0.8, 0.2))

b <- (b0 / b2 / b1 / b3 / b4) 
y_label + b + plot_layout(widths = c(0.1, 0.9))
ggsave("figures/dist.pdf", dpi=600)
```

# Figure - Overall 1 - num_pop
```{r, fig.width=4.6, fig.height=1.6, echo=FALSE, warning=FALSE, message=FALSE}
# --------------------------------------------------------------
# Overall
# --------------------------------------------------------------
my_comparisons <- list(
  c("EI", "E"), c("EI", "I"), c("E", "I"),  c("EI", "II"), c("E", "II"), c("I", "II"))

dmi_exp15 %>%
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p", "div_sub_p")) -> tmp

tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

tmp %>% 
  ggplot(aes(x=model, y=mi)) +
  geom_jitter(size=.02, alpha=0.01, width=0.3) +
  stat_summary(aes(group=model), fun.y=mean, 
               geom="point", colour="black", alpha=1, size=10, shape="_") +
  geom_hline(yintercept=0, color="dark grey", size=0.5) + xlab("") +
  labs(y=expression(paste(Delta, "MI")), x="Model", title="") +
  theme_classic() + 
  theme(plot.title = element_text(size = 7, hjust=3, face = "bold")) -> 
  p1

# --------------------------------------------------------------
# Timecourse
# --------------------------------------------------------------
dmi_exp15 %>%
  gather(model, mi, back_p:div_sub_p) %>% 
  group_by(model, stim_rate, g, num_pop) %>%
  summarise(m=mean(mi), sd=sd(mi)) %>%
  ungroup() %>% 
  filter(model %in% c("add_p","mult_p", "sub_p", "div_sub_p")) -> 
  tmp

# Set by hand. 
tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

dmi_exp15 %>%
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p", "div_sub_p")) -> 
  p_tmp
p_tmp$model <- revalue(p_tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
p_tmp$model <- factor(p_tmp$model, levels=c("E", "EI", "I", "II"))

tmp %>% 
  ggplot(aes(x=num_pop,  y=m, color=factor(g), group=factor(g))) +
  geom_line(size=0.7, alpha=1) +
  geom_ribbon(aes(ymin=m-sd, ymax=m+sd, fill=factor(g)), alpha=0.2, color=NA) +
  geom_hline(yintercept=0, color="dark grey") + xlab("") +
  scale_x_log10() +
  annotation_logticks(sides="b") + 
  labs(y=expression(paste(Delta, "MI")), x="Population size") +
  scale_color_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "slateblue4",
    "mediumpurple4"
    )) +
  scale_fill_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "slateblue4",
    "mediumpurple4"
    )) +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.text.x = element_text(face = "bold")) +
  facet_grid(.~model) ->
  p2

# --------------------------------------------------------------
# Build figure
# --------------------------------------------------------------
p1 + p2 + plot_layout(widths = c(0.15, 0.85)) +
  plot_annotation(tag_levels = 'a', tag_suffix = ".")
ggsave("figures/overall1.pdf", dpi=600)
```

# Figure - Overall 2 - small num_pop
```{r, fig.width=4.2, fig.height=3.2, echo=FALSE, warning=FALSE, message=FALSE}
# -----------------------------------------------------------
# stim_rate
# -----------------------------------------------------------
## Overall
# process
dmi_exp21 %>% 
   gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p", "div_sub_p")) -> tmp
tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

# plot
tmp %>% 
  ggplot(aes(x=model, y=mi)) +
  geom_jitter(size=.02, alpha=0.01, width=0.3) +
  stat_summary(aes(group=model), fun.y=mean, 
               geom="point", colour="black", alpha=1, size=10, shape="_") +
  geom_hline(yintercept=0, color="dark grey", size=0.5) + xlab("") +
  labs(y=expression(paste(Delta, "MI")), x="Model", title="") +
  theme_classic() + 
  theme(plot.title = element_text(size = 7, hjust=3, face = "bold")) -> 
  p1

## Timecourse
# process
dmi_exp21 %>% 
  filter(q == "0.5") %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  group_by(model, stim_rate, g, num_pop) %>%
  summarise(m=mean(mi), sd=sd(mi)) %>%
  ungroup() %>% 
  filter(model %in% c("add_p","mult_p", "sub_p", "div_sub_p")) -> 
  tmp
tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

# plot
tmp %>% 
  ggplot(aes(x=stim_rate,  y=m, color=factor(g), group=factor(g))) +
  geom_line(size=0.8, alpha=1) +
  geom_ribbon(aes(ymin=m-sd, ymax=m+sd, fill=factor(g)), alpha=0.2, color=NA) +
  geom_hline(yintercept=0, color="dark grey") + xlab("") +
  scale_x_continuous(breaks=c(5,10,15,20,15,20,25,30)) +
  labs(y=expression(paste(Delta, "MI")), x="Stimulus firing rate") +
  scale_color_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "slateblue4",
    "mediumpurple4"
    )) +
  scale_fill_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "slateblue4",
    "mediumpurple4"
    )) +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.text.x = element_text(face = "bold")) +
  facet_grid(.~model) ->
  p2

# -----------------------------------------------------------
# osc_rate 
# -----------------------------------------------------------
## overall
# process
dmi_exp22 %>%
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p", "div_sub_p")) -> tmp

tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

# plot
tmp %>% 
  ggplot(aes(x=model, y=mi)) +
  geom_jitter(size=.02, alpha=0.01, width=0.3) +
  stat_summary(aes(group=model), fun.y=mean, 
               geom="point", colour="black", alpha=1, size=10, shape="_") +
  geom_hline(yintercept=0, color="dark grey", size=0.5) + xlab("") +
  labs(y=expression(paste(Delta, "MI")), x="Model", title="") +
  theme_classic() + 
  theme(plot.title = element_text(size = 7, hjust=3, face = "bold")) -> 
  p3

## timecourse
# process
dmi_exp22 %>%
  filter(q == "0.5") %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  group_by(model, osc_rate, g, num_pop) %>%
  summarise(m=mean(mi), sd=sd(mi)) %>%
  ungroup() %>% 
  filter(model %in% c("add_p","mult_p", "sub_p", "div_sub_p")) -> 
  tmp
tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

# plot
tmp %>% 
  ggplot(aes(x=osc_rate,  y=m, color=factor(g), group=factor(g))) +
  geom_line(size=0.8, alpha=1) +
  geom_ribbon(aes(ymin=m-sd, ymax=m+sd, fill=factor(g)), alpha=0.2, color=NA) +
  geom_hline(yintercept=0, color="dark grey") + xlab("") +
  scale_x_continuous(breaks=c(2,6,10,14,18)) +
  labs(y=expression(paste(Delta, "MI")), x="Pacemaker firing rate") +
  scale_color_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "slateblue4",
    "mediumpurple4"
    )) +
  scale_fill_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "slateblue4",
    "mediumpurple4"
    )) +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(legend.position = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.text.x = element_text(face = "bold")) +
  facet_grid(.~model) ->
  p4

# -----------------------------------------------------------
# Build Figure
# -----------------------------------------------------------
((p1 / p3) | (p2 / p4)) + 
  plot_layout(widths = c(0.2, 0.8), guides = "collect") +
  plot_annotation(tag_levels = 'a', tag_suffix = ".", 
                  title="Population size: 40", 
                  theme=theme(plot.title = element_text(size = 11, face = "bold")))
ggsave("figures/overall2.pdf", dpi=600)
```

### Sig test results 
- For the paper.
```{r}

```

# Figure - Overall 3 - large num_pop
```{r, fig.width=4.2, fig.height=3.2, echo=FALSE, warning=FALSE, message=FALSE}
# -----------------------------------------------------------
# stim_rate
# -----------------------------------------------------------
## Overall
# process
dmi_exp18 %>% 
   gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p", "div_sub_p")) -> tmp
tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

# plot
tmp %>% 
  ggplot(aes(x=model, y=mi)) +
  geom_jitter(size=.02, alpha=0.01, width=0.3) +
  stat_summary(aes(group=model), fun.y=mean, 
               geom="point", colour="black", alpha=1, size=10, shape="_") +
  geom_hline(yintercept=0, color="dark grey", size=0.5) + xlab("") +
  labs(y=expression(paste(Delta, "MI")), x="Model", title="") +
  lims(y=c(-0.75, 0.25)) +
  theme_classic() + 
  theme(plot.title = element_text(size = 7, hjust=3, face = "bold")) -> 
  p1

## Timecourse
# process
dmi_exp18 %>% 
  filter(q == "0.5") %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  group_by(model, stim_rate, g, num_pop) %>%
  summarise(m=mean(mi), sd=sd(mi)) %>%
  ungroup() %>% 
  filter(model %in% c("add_p","mult_p", "sub_p", "div_sub_p")) -> 
  tmp
tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

# plot
tmp %>% 
  ggplot(aes(x=stim_rate,  y=m, color=factor(g), group=factor(g))) +
  geom_line(size=0.8, alpha=1) +
  geom_ribbon(aes(ymin=m-sd, ymax=m+sd, fill=factor(g)), alpha=0.2, color=NA) +
  geom_hline(yintercept=0, color="dark grey") + xlab("") +
  scale_x_continuous(breaks=c(5,10,15,20,15,20,25,30)) +
  lims(y=c(-0.75, 0.25)) +
  labs(y=expression(paste(Delta, "MI")), x="Stimulus firing rate") +
  scale_color_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "slateblue4",
    "mediumpurple4"
    )) +
  scale_fill_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "slateblue4",
    "mediumpurple4"
    )) +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.text.x = element_text(face = "bold")) +
  facet_grid(.~model) ->
  p2

# -----------------------------------------------------------
# osc_rate 
# -----------------------------------------------------------
## overall
# process
dmi_exp19 %>%
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p", "div_sub_p")) -> tmp
tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

# plot
tmp %>% 
  ggplot(aes(x=model, y=mi)) +
  geom_jitter(size=.02, alpha=0.01, width=0.3) +
  stat_summary(aes(group=model), fun.y=mean, 
               geom="point", colour="black", alpha=1, size=10, shape="_") +
  geom_hline(yintercept=0, color="dark grey", size=0.5) + xlab("") +
  lims(y=c(-0.75, 0.25)) +
  labs(y=expression(paste(Delta, "MI")), x="Model", title="") +
  theme_classic() + 
  theme(plot.title = element_text(size = 7, hjust=3, face = "bold")) -> 
  p3

## timecourse
# process
dmi_exp19 %>%
  filter(q == "0.5") %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  group_by(model, osc_rate, g, num_pop) %>%
  summarise(m=mean(mi), sd=sd(mi)) %>%
  ungroup() %>% 
  filter(model %in% c("add_p","mult_p", "sub_p", "div_sub_p")) -> 
  tmp
tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

# plot
tmp %>% 
  ggplot(aes(x=osc_rate,  y=m, color=factor(g), group=factor(g))) +
  geom_line(size=0.8, alpha=1) +
  geom_ribbon(aes(ymin=m-sd, ymax=m+sd, fill=factor(g)), alpha=0.2, color=NA) +
  geom_hline(yintercept=0, color="dark grey") + xlab("") +
  scale_x_continuous(breaks=c(2,6,10,14,18)) +
  lims(y=c(-0.75, 0.25)) +
  labs(y=expression(paste(Delta, "MI")), x="Pacemaker firing rate") +
  scale_color_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "slateblue4",
    "mediumpurple4"
    )) +
  scale_fill_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "slateblue4",
    "mediumpurple4"
    )) +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(legend.position = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.text.x = element_text(face = "bold")) +
  facet_grid(.~model) ->
  p4

# --------------------------------------------------------------
## Build Figure
((p1 / p3) | (p2 / p4)) + 
  plot_layout(widths = c(0.2, 0.8), guides = "collect") +
  plot_annotation(tag_levels = 'a', tag_suffix = ".", 
                  title="Population size: 10240",
                  theme=theme(plot.title = element_text(size = 11, face = "bold")))
ggsave("figures/overall3.pdf", dpi=600)
```

# Figure - Overall 4 - Div/sub (stim) small
```{r, fig.width=3.9, fig.height=1.4, echo=FALSE, warning=FALSE, message=FALSE}
# --------------------------------------------------------------
# Overall
# --------------------------------------------------------------
dmi_exp21 %>%
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("div_sub_p")) -> tmp
tmp$model <- revalue(tmp$model, c("div_sub_p"="II")) 

tmp %>% 
  ggplot(aes(x=model, y=mi)) +
  geom_jitter(size=.02, alpha=0.01, width=0.2) +
  stat_summary(aes(group=model), fun.y=mean, 
               geom="point", colour="black", alpha=1, size=10, shape="_") +
  geom_hline(yintercept=0, color="dark grey", size=0.5) +
  labs(y=expression(paste(Delta, "MI")), x="Model", title="") +
  lims(y=c(-0.4, 0)) +
  theme_classic() + 
  theme(plot.title = element_text(size = 7, hjust=3, face = "bold")) -> 
  p1

# --------------------------------------------------------------
# Timecourse
# --------------------------------------------------------------
dmi_exp21 %>%
  gather(model, mi, back_p:div_sub_p) %>% 
  group_by(model, q, stim_rate, g) %>%
  summarise(m=mean(mi), sd=sd(mi)) %>%
  ungroup() %>% 
  filter(model %in% c("div_sub_p")) -> 
  tmp
tmp$model <- revalue(tmp$model, c("div_sub_p"="II")) 

tmp %>% 
  ggplot(aes(x=stim_rate,  y=m, color=factor(g), group=factor(g))) +
  geom_line(size=0.7, alpha=1) +
  geom_ribbon(aes(ymin=m-sd, ymax=m+sd, fill=factor(g)), alpha=0.2, color=NA) +
  scale_x_continuous(breaks=c(5,10,15,20,15,20,25,30)) +
  lims(y=c(-0.4, 0)) +
  geom_hline(yintercept=0, color="dark grey") +
  labs(y=expression(paste(Delta, "MI")), x="Stimulus firing rate", title = "Division fraction") +
  scale_color_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "slateblue4",
    "mediumpurple4"
    )) +
  scale_fill_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "slateblue4",
    "mediumpurple4"
    )) +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(plot.title = element_text(size = 9, face = "bold")) +
  theme(strip.text.x = element_text(face = "bold")) +
  facet_grid(.~q) ->
  p2

# --------------------------------x------------------------------
## Build Figure
p1 + p2 + plot_layout(widths = c(0.07, 0.9)) +
  plot_annotation(tag_levels = 'a', tag_suffix = ".", 
                  title="Population size: 40",
                  theme=theme(plot.title = element_text(size = 11, face = "bold")))
ggsave("figures/overall4.pdf", dpi=600)
```

### Sig test results 
- For the paper.
```{r}
compare_means(mi~model, tmp,  p.adjust.method = "bonf")
```

# Figure - Control
## Other params
```{r, fig.width=2.1, fig.height=3.2, echo=FALSE, warning=FALSE, message=FALSE}
# --------------------------------------------------------------
dmi_exp9 %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p", "div_sub_p")) -> 
  tmp

tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

## Panel - Osc. freq.
tmp %>% 
  ggplot(aes(x=f, y=mi)) +
  geom_jitter(width=1, size=0.1, alpha=0.5) +
  stat_summary(aes(group=f), fun=mean, 
               geom="point", colour="black", alpha=1, size=6, shape="_") +
  geom_hline(yintercept=0, color="grey") + xlab("") +
  lims(x=c(1, 30), y=c(-0.3, 0.5)) + 
  labs(y=expression(paste(Delta, "MI")), x="Pacemaker frequency") +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(strip.text.x = element_text(face = "bold")) +
  facet_wrap(model~., nrow=1) ->
  p1


# --------------------------------------------------------------
## Panel - Background
dmi_exp12 %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p", "div_sub_p")) -> 
  tmp

tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

tmp %>% 
  ggplot(aes(x=num_background, y=mi)) +
  geom_jitter(width=0.75, size=0.1, alpha=0.5) +
  geom_hline(yintercept=0, color="grey") + xlab("") +
  stat_summary(aes(group=num_background), fun=mean, 
               geom="point", colour="black", alpha=1, size=6, shape="_") +
  lims(y=c(-0.3, 0.5)) +
  labs(y=expression(paste(Delta, "MI")), x="Background size") +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(strip.text.x = element_text(face = "bold")) +
  facet_wrap(model~., nrow=1) ->
  p4

# --------------------------------------------------------------
## Panel - Bin size
dmi_exp11 %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p", "div_sub_p")) -> 
  tmp

tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

tmp$m <- as.character((tmp$m))
tmp$m <- revalue(tmp$m, c("5"="m/2", "10"="m", "20"="2m")) 
tmp$m <- factor(tmp$m, levels=c("m/2", "m", "2m"))
tmp %>% 
  ggplot(aes(x=m, y=mi)) +
  geom_jitter(width=0.1, size=0.1, alpha=0.5) +
  geom_hline(yintercept=0, color="grey") + xlab("") +
  stat_summary(aes(group=m), fun=mean, 
               geom="point", colour="black", alpha=1, size=6, shape="_") +
  lims(y=c(-0.3, 0.5)) +
  labs(y=expression(paste(Delta, "MI")), x="Dist. bin size (m)") +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(strip.text.x = element_text(face = "bold")) +
  facet_wrap(model~., nrow=1) -> 
  p5

# --------------------------------------------------------------
p1 / p4 / p5 + 
  plot_annotation(tag_levels = 'a', tag_suffix = ".",
                  title="Population size: 40", 
                  theme=theme(plot.title = element_text(size = 11, face = "bold")))
ggsave("figures/control.pdf", dpi=600)
```

## Constant modulation
```{r, fig.width=2.4, fig.height=1.2, echo=FALSE, warning=FALSE, message=FALSE}
# --------------------------------------------------------------
load.data14 <- function(path, type, stim_rates, qs, num_pops){
  df <- NULL
  for(r_s in stim_rates){
    for(g in gs){
      for(n in num_pops){
        for(q in qs){
          try({
            name <- paste("stim_rate", as.character(r_s), 
                          "_g", as.character(g),
                          "_num_pop", as.character(n),
                          "_q", as.character(q),
                          "_", as.character(type), 
                          ".csv", sep="")
            di <- read.csv(paste(path, name, sep=""))
            di["stim_rate"] <- rep(r_s, nrow(di))
            di["g"] <- rep(g, nrow(di))
            di["num_pop"] <- rep(n, nrow(di))
            di["q"] <- rep(q, nrow(di))
            di["trial"] <- 1:nrow(di)
            df <- rbind(df, di)  
          })  
        }
      }
    }
  }
  df
}

# --------------------------------------------------------------
# Reload the exp8 data and loaf 14, but I need custom function for that.
# Note the exp8 reload gets labelled as exp8b to
path <- "~/Code/theoc/data/"

# Params
stim_rates <- c(5, 10, 15, 20, 25, 30)
gs <- c(1, 2, 3, 4, 5, 7, 8)
num_pops <- c(50)
qs <- c("0.5")

# Exp8 is the osc standard
exp_path <- paste(path, "/exp8/", sep="")
mi_exp8b <- load.data14(exp_path, "MI", stim_rates, qs, num_pops)
dmi_exp8b <- load.data14(exp_path, "dMI", stim_rates, qs, num_pops)

# Exp14 is what I'm interested in
exp_path <- paste(path, "/exp14/", sep="")
mi_exp14 <- load.data14(exp_path, "MI", stim_rates, qs, num_pops)
dmi_exp14 <- load.data14(exp_path, "dMI", stim_rates, qs, num_pops)

# Add labels, and full_join
mi_exp8b$exp <- "Osc."
mi_exp14$exp <- "Tonic"
dmi_exp8b$exp <- "Osc."
dmi_exp14$exp <- "Tonic"
mi <- full_join(mi_exp8b, mi_exp14)
dmi <- full_join(dmi_exp8b, dmi_exp14)

# --------------------------------------------------------------
# Join 8 and14
dmi %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp

tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II")) 
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))
tmp$exp <- factor(tmp$exp, levels=c("Osc.", "Tonic"))

# --------------------------------------------------------------
# Average by cond, and plot by exp
tmp %>% 
  group_by(stim_rate,g,exp,model) %>% 
  summarise(m=mean(mi)) ->
  tmp

tmp %>%
  ggplot(aes(x=exp, y=m, group=interaction(stim_rate,g))) +
  geom_line(size=0.2, alpha=0.3) +
  geom_point(size=0.3, alpha=0.3) +
  stat_summary(aes(group=exp), fun=mean,
               geom="point", colour="black", alpha=1, size=6, shape="_") +
  geom_hline(yintercept=0, size=0.4, color="dark grey") +
  labs(y=expression(paste(Delta, "MI")), x="") +
  lims(y=c(-0.4, 0.4)) +
  facet_grid(model~., scale = "free_y") +
  theme_classic2() +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  # theme(strip.text.x = element_blank()) +
  # theme(axis.text.x = element_text(angle = 90, vjust = 1)) +
  theme(strip.text.x = element_text(angle = 0, face = "bold")) +
  facet_grid(.~model, scale = "free_y") ->
  p1

# --------------------------------------------
p1 + plot_annotation(title="Population size: 40",
                     theme=theme(plot.title = element_text(size = 11, face = "bold")))
ggsave("figures/constant.pdf", dpi=600) 
```

# Testing  - pop
```{r, fig.width=4.2, fig.height=2, echo=FALSE, warning=FALSE, message=FALSE}
# -------------------------------------
# Testing
tmp <- NULL

# # Join exp 8, 15 16
# dmi_exp8 %>% 
#   gather(model, dmi, back_p:div_sub_p) %>% 
#   filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
#   tmp1
# pow_exp8 %>% 
#   gather(model, pow, back_p:div_sub_p) %>% 
#   filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
#   tmp2
# tmp <- full_join(tmp1, tmp2)

# -
dmi_exp15 %>% 
  gather(model, dmi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp1
pow_exp15 %>% 
  gather(model, pow, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp2
tmp <- full_join(tmp1, tmp2)
# tmp <- full_join(tmp, tmp2)


# -
# dmi_exp16 %>% 
#   gather(model, dmi, back_p:div_sub_p) %>% 
#   filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
#   tmp1
# pow_exp16 %>% 
#   gather(model, pow, back_p:div_sub_p) %>% 
#   filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
#   tmp2
# tmp <- full_join(tmp, tmp1)
# tmp <- full_join(tmp, tmp2)


# -------------------------------------
tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II"))
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

tmp %>% 
  # filter(num_pop == 1280) %>%
  ggplot(aes(x=pow, y=dmi)) +
  geom_point(size=0.3, alpha=0.2) +
  scale_color_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "mediumpurple4"
    )) +
  stat_smooth(aes(x=pow, y=dmi, color=factor(g)), method="lm", se = FALSE, alpha=1) +
  geom_hline(yintercept=0, color="dark grey") + 
  labs(y=expression(paste(Delta, "MI")), x="Spectral power", tag="") +
  theme_classic2() +
  theme(plot.title = element_text(size = 9, hjust=1, face = "bold")) +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  # theme(legend.position = "none") +
  # theme(strip.text.x = element_blank()) +
  theme(strip.text.y = element_text(angle = 0, face = "bold")) +
  facet_grid(model~num_pop, scale = "free_y") -> p1
p1 
```
# Testing - stim_rate
```{r, fig.width=3.2, fig.height=2, echo=FALSE, warning=FALSE, message=FALSE}
# -------------------------------------
# Testing
tmp <- NULL

# # Join exp 8, 15 16
dmi_exp8 %>%
  gather(model, dmi, back_p:div_sub_p) %>%
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) ->
  tmp1
pow_exp8 %>%
  gather(model, pow, back_p:div_sub_p) %>%
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) ->
  tmp2
tmp <- full_join(tmp1, tmp2)

# -
# dmi_exp16 %>%
  # gather(model, dmi, back_p:div_sub_p) %>%
  # filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) ->
  # tmp1
# pow_exp15 %>% 
#   gather(model, pow, back_p:div_sub_p) %>% 
#   filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
#   tmp2
# tmp <- full_join(tmp1, tmp2)
# tmp <- full_join(tmp, tmp2)

# pow_exp16 %>%
  # gather(model, pow, back_p:div_sub_p) %>%
  # filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) ->
  # tmp2
# tmp <- full_join(tmp1, tmp2)
# tmp <- full_join(tmp, tmp2)


# -------------------------------------
# -------------------------------------
tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II"))
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

tmp %>% 
  ggplot(aes(x=stim_rate, y=pow, color=dmi)) +
  geom_jitter(size=0.3, alpha=0.2) +
  scale_color_gradient2(low="blue", high="red") +
  theme_classic2() +
  stat_summary(aes(group=stim_rate), fun.y=mean, 
               geom="point", colour="black", alpha=1, size=4, shape="_") +
  theme(plot.title = element_text(size = 9, hjust=1, face = "bold")) +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(strip.text.y = element_text(angle = 0, face = "bold")) +
  facet_grid(model~g, scale = "free_y") -> p1
p1 
```
# Testing - osc_rate
```{r, fig.width=1.4, fig.height=2.4, echo=FALSE, warning=FALSE, message=FALSE}
# -------------------------------------
# Testing
tmp <- NULL

# # Join exp 8, 15 16
# dmi_exp8 %>%
#   gather(model, dmi, back_p:div_sub_p) %>%
#   filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) ->
#   tmp1
# pow_exp8 %>%
#   gather(model, pow, back_p:div_sub_p) %>%
#   filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) ->
#   tmp2
# tmp <- full_join(tmp1, tmp2)

# -
dmi_exp16 %>%
gather(model, dmi, back_p:div_sub_p) %>%
filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) ->
tmp1
pow_exp15 %>%
  gather(model, pow, back_p:div_sub_p) %>%
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) ->
  tmp2
tmp <- full_join(tmp1, tmp2)

# pow_exp16 %>%
  # gather(model, pow, back_p:div_sub_p) %>%
  # filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) ->
  # tmp2
# tmp <- full_join(tmp1, tmp2)
# tmp <- full_join(tmp, tmp2)


# -------------------------------------
tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II"))
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))
tmp %>% 
  filter(g ==2) %>% 
  ggplot(aes(x=osc_rate, y=pow, color=dmi)) +
  geom_jitter(size=0.3, alpha=0.2) +
  scale_color_gradient2(low="blue", high="red") +
  theme_classic2() +
  stat_summary(aes(group=osc_rate), fun.y=mean, 
               geom="point", colour="black", alpha=1, size=4, shape="_") +
  theme(plot.title = element_text(size = 9, hjust=1, face = "bold")) +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(strip.text.y = element_text(angle = 0, face = "bold")) +
  facet_grid(model~., scale = "free_y") -> p1
p1 
```

# Figure - power all
```{r, fig.width=2.2, fig.height=2.1, echo=FALSE, warning=FALSE, message=FALSE}
# stim
dmi_exp8 %>% 
  gather(model, dmi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p")) -> 
  tmp1
pow_exp8 %>% 
  gather(model, pow, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p")) -> 
  tmp2
s_tmp <- full_join(tmp1, tmp2)

dmi_exp13 %>% 
  gather(model, dmi, back_p:div_sub_p) %>% 
  filter(model %in% c("div_sub_p")) -> 
  tmp1
pow_exp13 %>% 
  gather(model, pow, back_p:div_sub_p) %>% 
  filter(model %in% c("div_sub_p")) -> 
  tmp2

tmp3 <- full_join(tmp1, tmp2)
s_tmp <- bind_rows(s_tmp, tmp3)
s_tmp$osc_rate <- 2
rm(tmp3)

s_tmp$model <- revalue(s_tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II"))
s_tmp$model <- factor(s_tmp$model, levels=c("E", "EI", "I", "II"))

# num_pop
dmi_exp15 %>% 
  gather(model, dmi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp1
pow_exp15 %>% 
  gather(model, pow, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp2
n_tmp <- full_join(tmp1, tmp2)
n_tmp$model <- revalue(n_tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II"))
n_tmp$model <- factor(n_tmp$model, levels=c("E", "EI", "I", "II"))
n_tmp$osc_rate <- 2

# osc_rate
dmi_exp16 %>% 
  gather(model, dmi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp1
pow_exp16 %>% 
  gather(model, pow, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp2
o_tmp <- full_join(tmp1, tmp2)
o_tmp$model <- revalue(o_tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II"))
o_tmp$model <- factor(o_tmp$model, levels=c("E", "EI", "I", "II"))

# -------------------------------------
tmp <- bind_rows(s_tmp, n_tmp)
tmp <- bind_rows(tmp, o_tmp)

tmp %>% 
  ggplot(aes(x=pow, y=dmi)) +
  geom_point(size=0.1, alpha=0.1) +
  stat_smooth(method="lm", se = FALSE, alpha=1, color="darkgrey") +
  geom_hline(yintercept=0, color="dark grey") + 
  labs(y=expression(paste(Delta, "MI")), x="Spectral power", tag="b.") +
  theme_classic2() +
  theme(plot.title = element_text(size = 9, hjust=1, face = "bold")) +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(legend.position = "none") +
  theme(strip.text.x = element_blank()) +
  theme(strip.text.y = element_text(angle = 0, face = "bold")) -> p1

p1
ggsave("figures/pow0.pdf", dpi=600)
```
# Figure - by kind
```{r, fig.width=1.3, fig.height=3.1, echo=FALSE, warning=FALSE, message=FALSE}
tmp <- NULL

# Join exp 8, 15 16
dmi_exp8 %>% 
  gather(model, dmi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp1
pow_exp8 %>% 
  gather(model, pow, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp2
tmp <- full_join(tmp1, tmp2)

# -
dmi_exp15 %>% 
  gather(model, dmi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp1
pow_exp15 %>% 
  gather(model, pow, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp2
tmp <- full_join(tmp, tmp1)
tmp <- full_join(tmp, tmp2)


# -
dmi_exp16 %>% 
  gather(model, dmi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp1
pow_exp16 %>% 
  gather(model, pow, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp2
tmp <- full_join(tmp, tmp1)
tmp <- full_join(tmp, tmp2)


# -------------------------------------
tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II"))
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

tmp %>% 
  filter(stim_rate == 20, model == "EI") %>% 
  ggplot(aes(x=pow, y=dmi)) + #, color=factor(g))) +
  geom_point(size=1.2, alpha=0.2) +
  scale_color_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "mediumpurple4"
    )) +
  stat_smooth(method="lm", se = FALSE, alpha=1, color="darkgrey") +
  geom_hline(yintercept=0, color="dark grey") + 
  labs(y=expression(paste(Delta, "MI")), x="Spectral power", tag="b.") +
  theme_classic2() +
  theme(plot.title = element_text(size = 9, hjust=1, face = "bold")) +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(legend.position = "none") +
  theme(strip.text.x = element_blank()) +
  theme(strip.text.y = element_text(angle = 0, face = "bold")) +
  facet_grid(model~., scale = "free_y") ->
  p1

tmp %>% 
  filter(stim_rate == 20, model == "E") %>% 
  ggplot(aes(x=pow, y=dmi)) + #, color=factor(g))) +
  geom_point(size=1.2, alpha=0.2) +
  scale_color_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "mediumpurple4"
    )) +
  stat_smooth(method="lm", se = FALSE, alpha=1, color="darkgrey") +
  geom_hline(yintercept=0, color="dark grey") + 
  labs(y=expression(paste(Delta, "MI")), x="Spectral power",  tag="a.", title="Power and MI") +
  theme_classic2() +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(strip.text.x = element_blank()) +
  theme(plot.title = element_text(size = 9, hjust=1, face = "bold")) +
  theme(strip.text.y = element_text(angle = 0, face = "bold")) +
  facet_grid(model~., scale = "free_y") ->
  p2

tmp %>% 
  filter(stim_rate == 20, model == "I") %>% 
  ggplot(aes(x=pow, y=dmi)) + #, color=factor(g))) +
  geom_point(size=1.2, alpha=0.2) +
  scale_color_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "mediumpurple4"
    )) +
  stat_smooth(method="lm", se = FALSE, alpha=1, color="darkgrey") +
  geom_hline(yintercept=0, color="dark grey") + 
  labs(y=expression(paste(Delta, "MI")), x="Spectral power",  tag="c.") +
  theme_classic2() +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(strip.text.x = element_blank()) +
  theme(strip.text.y = element_text(angle = 0, face = "bold")) +
  facet_grid(model~., scale = "free_y") ->
  p3

col1 <- p2 / p1 / p3 + plot_layout(guides = "collect") 
  
# ----------------------------------------------------------------
col1 
ggsave("figures/pow1.pdf", dpi=600)
```

# Figure - by kind/g
```{r, fig.width=1.6, fig.height=3.1, echo=FALSE, warning=FALSE, message=FALSE}
tmp <- NULL

# Join exp 8, 15 16
dmi_exp8 %>% 
  gather(model, dmi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp1
pow_exp8 %>% 
  gather(model, pow, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp2
tmp <- full_join(tmp1, tmp2)

# -
dmi_exp15 %>% 
  gather(model, dmi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp1
pow_exp15 %>% 
  gather(model, pow, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp2
tmp <- full_join(tmp, tmp1)
tmp <- full_join(tmp, tmp2)


# -
dmi_exp16 %>% 
  gather(model, dmi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp1
pow_exp16 %>% 
  gather(model, pow, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p", "div_sub_p")) -> 
  tmp2
tmp <- full_join(tmp, tmp1)
tmp <- full_join(tmp, tmp2)


# -------------------------------------
tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p"="II"))
tmp$model <- factor(tmp$model, levels=c("E", "EI", "I", "II"))

tmp %>% 
  filter(stim_rate == 20, model == "EI") %>% 
  ggplot(aes(x=pow, y=dmi, color=factor(g))) +
  geom_point(size=1.2, alpha=0.2) +
  scale_color_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "mediumpurple4"
    )) +
  stat_smooth(method="lm", se = FALSE, alpha=1) +
  geom_hline(yintercept=0, color="dark grey") + 
  labs(y=expression(paste(Delta, "MI")), x="Spectral power", tag="b.") +
  theme_classic2() +
  theme(plot.title = element_text(size = 9, hjust=1, face = "bold")) +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(legend.position = "none") +
  theme(strip.text.x = element_blank()) +
  theme(strip.text.y = element_text(angle = 0, face = "bold")) +
  facet_grid(model~., scale = "free_y") ->
  p1

tmp %>% 
  filter(stim_rate == 20, model == "E") %>% 
  ggplot(aes(x=pow, y=dmi, color=factor(g))) +
  geom_point(size=1.2, alpha=0.2) +
  scale_color_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "mediumpurple4"
    )) +
  stat_smooth(method="lm", se = FALSE, alpha=1) +
  geom_hline(yintercept=0, color="dark grey") + 
  labs(y=expression(paste(Delta, "MI")), x="Spectral power",  tag="a.", title="Power and MI") +
  theme_classic2() +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(strip.text.x = element_blank()) +
  theme(plot.title = element_text(size = 9, hjust=1, face = "bold")) +
  theme(strip.text.y = element_text(angle = 0, face = "bold")) +
  facet_grid(model~., scale = "free_y") ->
  p2

tmp %>% 
  filter(stim_rate == 20, model == "I") %>% 
  ggplot(aes(x=pow, y=dmi, color=factor(g))) +
  geom_point(size=1.2, alpha=0.2) +
  scale_color_manual("g", values = c(
    "lightsteelblue3",
    "lightskyblue3",
    "steelblue3",
    "steelblue4",
    "slateblue2", 
    "slateblue3",
    "mediumpurple4"
    )) +
  stat_smooth(method="lm", se = FALSE, alpha=1) +
  geom_hline(yintercept=0, color="dark grey") + 
  labs(y=expression(paste(Delta, "MI")), x="Spectral power",  tag="c.") +
  theme_classic2() +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(strip.text.x = element_blank()) +
  theme(strip.text.y = element_text(angle = 0, face = "bold")) +
  facet_grid(model~., scale = "free_y") ->
  p3

col1 <- p2 / p1 / p3 + plot_layout(guides = "collect") 
  
# ----------------------------------------------------------------
col1 
ggsave("figures/pow2.pdf", dpi=600)
```

