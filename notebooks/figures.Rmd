---
title: "Paper figures - Balanced oscillations improve information flow (2020 edition)"
output: html_notebook
---

# Libraries and helpers
```{r helper_fns, echo=FALSE, fig.width=6, fig.height=4, echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(grid)
library(gridExtra)
library(plyr)
library(readr)
library(dplyr)
library(png)
library(psd)
library(tidyr)
library(patchwork)
library(scales)
library(ggpubr)
library(cowplot)
library(latex2exp)
# library(NNTbiomarker)
# library(bspec)

load.data1 <- function(path, type, stim_rates, qs, num_pops, pns){
  df <- NULL
  for(r_s in stim_rates){
    for(g in gs){
      for(n in num_pops){
        for(q in qs){
          try({
            name <- paste("stim_rate", as.character(r_s), 
                          "_g", as.character(g),
                          "_num_pop", as.character(n),
                          "_q", as.character(q),
                          "_", as.character(type), 
                          ".csv", sep="")
            di <- read.csv(paste(path, name, sep=""))
            di["stim_rate"] <- rep(r_s, nrow(di))
            di["g"] <- rep(g, nrow(di))
            di["num_pop"] <- rep(n, nrow(di))
            di["q"] <- rep(q, nrow(di))
            di["trial"] <- 1:nrow(di)
            df <- rbind(df, di)  
          })  
        }
      }
    }
  }
  df
}
load.data2 <- function(path, type, fs){
  df <- NULL
  for(f in fs){
    try({
      # stim_rate-_2_g-11_num_pop-10_q-0.0_rate
      name <- paste("f", as.character(f), 
                    "_", as.character(type), 
                    ".csv", sep="")
      di <- read.csv(paste(path, name, sep=""))
      di["f"] <- rep(f, nrow(di))
      di["trial"] <- 1:nrow(di)
      df <- rbind(df, di)  
    })  
  }
  df
}
load.data3 <- function(path, type, osc_rates){
  df <- NULL
  for(o_r in osc_rates){
    try({
      # stim_rate-_2_g-11_num_pop-10_q-0.0_rate
      name <- paste("osc_rate", as.character(o_r), 
                    "_", as.character(type), 
                    ".csv", sep="")
      di <- read.csv(paste(path, name, sep=""))
      di["osc_rate"] <- rep(o_r, nrow(di))
      di["trial"] <- 1:nrow(di)
      df <- rbind(df, di)  
    })  
  }
  df
}
load.data4 <- function(path, type, ms){
  df <- NULL
  for(m in ms){
    try({
      # stim_rate-_2_g-11_num_pop-10_q-0.0_rate
      name <- paste("m", as.character(m), 
                    "_", as.character(type), 
                    ".csv", sep="")
      di <- read.csv(paste(path, name, sep=""))
      di["m"] <- rep(m, nrow(di))
      di["trial"] <- 1:nrow(di)
      df <- rbind(df, di)  
    })  
  }
  df
}
load.data5 <- function(path, type, num_backgrounds){
  df <- NULL
  for(n_b in num_backgrounds){
    try({
      # stim_rate-_2_g-11_num_pop-10_q-0.0_rate
      name <- paste("num_background", as.character(n_b), 
                    "_", as.character(type), 
                    ".csv", sep="")
      di <- read.csv(paste(path, name, sep=""))
      di["num_background"] <- rep(n_b, nrow(di))
      di["trial"] <- 1:nrow(di)
      df <- rbind(df, di)  
    })  
  }
  df
}
load.data6 <- function(path, type, num_pops){
  df <- NULL
  for(n_p in num_pops){
    try({
      # stim_rate-_2_g-11_num_pop-10_q-0.0_rate
      name <- paste("num_pop", as.character(n_p), 
                    "_", as.character(type), 
                    ".csv", sep="")
      di <- read.csv(paste(path, name, sep=""))
      di["num_pop"] <- rep(n_p, nrow(di))
      di["trial"] <- 1:nrow(di)
      df <- rbind(df, di)  
    })  
  }
  df
}
```

# Load data
## Exp 1 - the main results 
```{r load1, message=FALSE, warning=FALSE, error=FALSE}
path <- "~/Code/theoc/data/"

# 5 10 15 20 25 30 ::: 1 2 3 4 5 7 8 ::: 0.0 0.25 0.5 0.75 1.0 ::: 10 25 50 75 100 500 
stim_rates <- c(5, 10, 15, 20, 25, 30)
gs <- c(1, 2, 3, 4, 5, 6, 7, 8)
num_pops <- c(10, 25, 50, 75, 100, 500)
qs <- c("0.0", "0.25", "0.5", "0.75", "1.0")

exp1path <- paste(path, "/exp1/", sep="")
mi_exp1 <- load.data1(exp1path, "MI", stim_rates, qs, num_pops, qs)
dmi_exp1 <- load.data1(exp1path, "dMI", stim_rates, qs, num_pops, qs)
h_exp1 <- load.data1(exp1path, "H", stim_rates, qs, num_pops, qs)
pac_exp1 <- load.data1(exp1path, "PAC", stim_rates, qs, num_pops, qs)
```

## Exp 2-6 - control experiments
```{r load26, message=FALSE, warning=FALSE, error=FALSE}
path <- "~/Code/theoc/data/"

# exp2
fs <- c(4, 6, 8, 12, 20, 30)
exp_path <- paste(path, "/exp2/", sep="")
mi_exp2 <- load.data2(exp_path, "MI", fs)
dmi_exp2 <- load.data2(exp_path, "dMI", fs)
h_exp2 <- load.data2(exp_path, "H", fs)

# exp3
osc_rates <- c(2, 3, 4, 6, 8)
exp_path <- paste(path, "/exp3/", sep="")
mi_exp3 <- load.data3(exp_path, "MI", osc_rates)
dmi_exp3 <- load.data3(exp_path, "dMI", osc_rates)
h_exp3 <- load.data3(exp_path, "H", osc_rates)

# exp4
ms <- c(10, 20, 40)
exp_path <- paste(path, "/exp4/", sep="")
mi_exp4 <- load.data4(exp_path, "MI", ms)
dmi_exp4 <- load.data4(exp_path, "dMI", ms)
h_exp4 <- load.data4(exp_path, "H", ms)

# exp5
num_backgrounds <- c(5, 10, 15, 20, 25)
exp_path <- paste(path, "/exp5/", sep="")
mi_exp5 <- load.data5(exp_path, "MI", num_backgrounds)
dmi_exp5 <- load.data5(exp_path, "dMI", num_backgrounds)
h_exp5 <- load.data5(exp_path, "H", num_backgrounds)

# exp6
num_pops <- c(10, 20, 40, 80, 160, 320, 640, 1280)
exp_path <- paste(path, "/exp6/", sep="")
mi_exp6 <- load.data6(exp_path, "MI", num_pops)
dmi_exp6 <- load.data6(exp_path, "dMI", num_pops)
h_exp6 <- load.data6(exp_path, "H", num_pops)
```

# Figure 1 - examples of the model output

# Figure 2 - Mutual information and oscillation
## Panel - FI arithmatic
```{r, fig.width=01.2, fig.height=1.85, echo=FALSE, warning=FALSE, message=FALSE}
phi1 <- function(x) {
  30 / (1 + exp(-.2*x + 5))
}

phi2 <- function(x, m, b) {
  x <- x - b
  x[x <= 0] <- 0
  x <- x * m
}

input = 1:100
fi = data.frame(
  ref=phi2(input, 1, 20), 
  add=phi2(input+10, 1, 20), 
  sub=phi2(input-10, 1, 20), 
  mult=phi2(input*1.5, 1, 20))

fi %>% 
  ggplot(aes(x=input, y=add)) +
  geom_line(color="black") +
  geom_line(data=fi, mapping=aes(x=input, y=ref), color="grey") +
  theme_classic() +
  geom_segment(aes(x = 34, xend = 14, y = 30, yend = 30),
                  lineend = "round", linejoin = "round",
                  size=.08,
                  arrow = arrow(length = unit(0.1, "cm"))) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) ->
  p1

fi %>% 
  ggplot(aes(x=input, y=sub)) +
  geom_line(color="black") +
  geom_line(data=fi, mapping=aes(x=input, y=ref), color="grey") +
  theme_classic() + 
  labs(y="Output") +
  geom_segment(aes(x = 66, xend = 86, y = 30, yend = 30),
                  lineend = "round", linejoin = "round",
                  size=.08,
                  arrow = arrow(length = unit(0.1, "cm"))) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        #axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) -> 
  p2
# plot(p2)

fi %>% 
  ggplot(aes(x=input, y=mult)) +
  geom_line(color="black") +
  geom_line(data=fi, mapping=aes(x=input, y=ref), color="grey") +
  theme_classic() + 
  labs(x="Input") +
  geom_curve(aes(x = 70, xend = 60, y = 55, yend = 64),
                  lineend = "round", linejoin = "round",
                  size=.08,
                  arrow = arrow(length = unit(0.1, "cm"))) +
  theme(#axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) ->  
  p3
# plot(p3)

p1_label <- as_ggplot(text_grob("E", hjust=3))
p2_label <- as_ggplot(text_grob("I", hjust=6))
p3_label <- as_ggplot(text_grob("EI", hjust=2))

(p1 + p1_label) / (p2 + p2_label) / (p3 + p3_label)
ggsave("figures/fi1.png", dpi=600)
```


## Panel - Modulation overall 
```{r, fig.width=1.1, fig.height=1, echo=FALSE, warning=FALSE, message=FALSE}
dmi_exp1 %>% 
  filter(q == "0.0") %>% 
  filter(num_pop == 50) %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p")) -> 
  tmp

tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I")) 
tmp$model <- factor(tmp$model, levels=c("EI", "E", "I"))

my_comparisons <- list( c("EI", "E"), c("EI", "I"), c("E", "I") )
tmp %>% 
  ggplot(aes(x=model, y=mi)) +
  lims(y=c(-.5, 0.75)) +
  geom_jitter(size=.3, alpha=0.2) +
  geom_hline(yintercept=0, color="dark grey") + xlab("") +
  labs(y=expression(paste(Delta, "MI")), x="") +
  stat_compare_means(comparisons = my_comparisons, label = "p.signif", label.y = c(0.55, 0.7, 0.2)) +
  theme_classic() -> 
  p1
plot(p1)
```
### Sig test results 
- For the paper.
```{r}
compare_means(mi~model, tmp)
```

## Panel - Oscillation overall
```{r, fig.width=0.6, fig.height=1, echo=FALSE, warning=FALSE, message=FALSE}
dmi_exp1 %>% 
  filter(q == "0.0") %>% 
  filter(num_pop == 50) %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("osc_p")) -> tmp

tmp$model <- revalue(tmp$model, c("osc_p"="O")) 

tmp %>% 
  ggplot(aes(x=model, y=mi)) +
  geom_jitter(size=.3, alpha=0.2) +
  geom_hline(yintercept=0, color="dark grey") + xlab("") +
  lims(y=c(-.5, 0.75)) +
  labs(y=expression(paste(Delta, "MI")), x="") +
  theme_classic() -> 
  p2
plot(p2)
```
## Panel - Timecourses of stimulus strength, and g.
```{r, fig.width=2, fig.height=1, echo=FALSE, warning=FALSE, message=FALSE}
dmi_exp1 %>% 
  filter(q == "0.0") %>% 
  filter(num_pop == 50) %>% 
  group_by(stim_rate, g, num_pop) %>%
  summarise(add_p=mean(add_p),
            back_p=mean(back_p),
            div_sub_p=mean(div_sub_p),
            mult_p=mean(mult_p),
            osc_p=mean(osc_p),
            stim_p=mean(stim_p),
            sub_p=mean(sub_p)) %>%
  ungroup() %>%
  gather(model, mi, add_p:sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p")) -> 
  tmp

tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I")) 
tmp$model <- factor(tmp$model, levels=c("EI", "E", "I"))

tmp %>% 
  ggplot(aes(x=stim_rate, y=mi, color=g, group=g)) +
  geom_line(size=0.5, alpha=0.9) +
  geom_point(size=0.7, alpha=1) +
  geom_hline(yintercept=0, color="dark grey") + xlab("") +
  lims(y=c(-.5, 0.75)) +
  labs(y=expression(paste(Delta, "MI")), x="Stimulus firing rate") +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(strip.text.x = element_text(face = "bold")) +
  facet_grid(.~model) ->
  p3
plot(p3)
```
## Build Figure 2
```{r, fig.width=3.5, fig.height=1.2, echo=FALSE, warning=FALSE, message=FALSE}
p1 + p2 + p3 + 
  plot_layout(widths = c(2, 0.75, 6)) +
  plot_annotation(tag_levels = 'a', tag_suffix = ".")
ggsave("figures/figure2.pdf", dpi=600)
```

# Figure 2 - Control exps for MI
## Panel - Osc. freq.
```{r, fig.width=1.7, fig.height=0.8, echo=FALSE, warning=FALSE, message=FALSE}
dmi_exp2 %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p")) -> 
  tmp

tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I")) 
tmp$model <- factor(tmp$model, levels=c("EI", "E", "I"))

tmp %>% 
  ggplot(aes(x=f, y=mi)) +
  geom_point(size=.3, alpha=0.2) +
  geom_hline(yintercept=0, color="darkgrey") + xlab("") +
  lims(x=c(1, 30), y=c(-0.5, 0.75)) +
  labs(y=expression(paste(Delta, "MI")), x="Oscillation frequency") +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(strip.text.x = element_text(face = "bold")) +
  facet_wrap(model~., nrow=1) ->
  p1
plot(p1)
```

## Panel - Osc. firing rate
```{r, fig.width=1.7, fig.height=1, echo=FALSE, warning=FALSE, message=FALSE}
dmi_exp3 %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p"))-> 
  tmp

tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I")) 
tmp$model <- factor(tmp$model, levels=c("EI", "E", "I"))

tmp %>% 
  ggplot(aes(x=osc_rate, y=mi)) +
  geom_point(size=.3, alpha=0.2) +
  geom_hline(yintercept=0, color="grey") + xlab("") +
  labs(y=expression(paste(Delta, "MI")), x="Oscillation firing rate") +
  lims(x=c(1, 8), y=c(-0.5, 0.75)) +
  theme_classic() +
  theme(strip.text.x = element_text(face = "bold")) +
  theme(strip.background = element_blank()) +
  facet_wrap(model~., nrow=1) ->
  p2
plot(p2)
```
## Panel - Population size
```{r, fig.width=2, fig.height=1, echo=FALSE, warning=FALSE, message=FALSE}
dmi_exp6 %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p"))-> 
  tmp

tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I")) 
tmp$model <- factor(tmp$model, levels=c("EI", "E", "I"))

tmp %>% 
  ggplot(aes(x=num_pop, y=mi)) +
  geom_point(size=.3, alpha=0.2) +
  geom_hline(yintercept=0, color="grey") +
  lims(y=c(-0.5, 0.75)) +
  scale_x_log10()+
  annotation_logticks(base = 10, sides = "b") +
  labs(y=expression(paste(Delta, "MI")), x="Population size") +
  theme_classic() +
  theme(strip.text.x = element_text(face = "bold")) +
  theme(strip.background = element_blank()) +
  facet_wrap(model~., nrow=1) ->
  p3
plot(p3)
```


## Panel - Background
```{r, fig.width=1.7, fig.height=1, echo=FALSE, warning=FALSE, message=FALSE}
dmi_exp5 %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p"))-> 
  tmp

tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I")) 
tmp$model <- factor(tmp$model, levels=c("EI", "E", "I"))

tmp %>% 
  ggplot(aes(x=num_background, y=mi)) +
  geom_point(size=.3, alpha=0.2) +
  geom_hline(yintercept=0, color="grey") + xlab("") +
  lims(y=c(-0.5, 0.75)) +
  labs(y=expression(paste(Delta, "MI")), x="Background size") +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(strip.text.x = element_text(face = "bold")) +
  facet_wrap(model~., nrow=1) ->
  p4
plot(p4)
```

## Panel - Bin size
```{r, fig.width=1.7, fig.height=0.8, echo=FALSE, warning=FALSE, message=FALSE}
dmi_exp4 %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p","mult_p", "sub_p"))-> 
  tmp

tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I")) 
tmp$model <- factor(tmp$model, levels=c("EI", "E", "I"))

tmp$m <- as.character((tmp$m))
tmp$m <- revalue(tmp$m, c("10"="m/2", "20"="m", "40"="2m")) 
tmp$m <- factor(tmp$m, levels=c("m/2", "m", "2m"))
tmp %>% 
  ggplot(aes(x=m, y=mi)) +
  geom_point(size=.3, alpha=0.2) +
  geom_hline(yintercept=0, color="grey") + xlab("") +
  lims(y=c(-0.5, 0.75)) +
  labs(y=expression(paste(Delta, "MI")), x="Entropy bin size (m)") +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(strip.text.x = element_text(face = "bold")) +
  facet_wrap(model~., nrow=1) -> 
  p5
plot(p5)
```

## Build Figure
```{r, fig.width=2.1, fig.height=4.4, echo=FALSE, warning=FALSE, message=FALSE}
p1 / p2 / p3 / p4 / p5 + 
  plot_annotation(tag_levels = 'a', tag_suffix = ".")
ggsave("figures/figure3.pdf", dpi=600)
```
# FIgure - PAC and info
Plot raw, not deltas. Overall r_s, g, pop_size=50.
1. PAC v H (E,I,EI)
2. PAC v MI (....)
3. PAC v MI, split by E,I,EI models and S alone.
```{r, fig.width=1.4, fig.height=2.1, echo=FALSE, warning=FALSE, message=FALSE}
# E, I, IE
h_exp1 %>% 
  filter(q == "0.0") %>% 
  filter(num_pop == 50) %>% 
  gather(model, h, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p")) -> 
  tmp1

mi_exp1 %>% 
  filter(q == "0.0") %>% 
  filter(num_pop == 50) %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p")) -> 
  tmp2

dmi_exp1 %>% 
  filter(q == "0.0") %>% 
  filter(num_pop == 50) %>% 
  gather(model, dmi, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p")) -> 
  tmp3

pac_exp1 %>% 
  filter(q == "0.0") %>% 
  filter(num_pop == 50) %>% 
  gather(model, pac, back_p:div_sub_p) %>% 
  filter(model %in% c("add_p", "mult_p", "sub_p")) -> 
  tmp4

tmp <- full_join(tmp1, tmp2)
tmp <- full_join(tmp, tmp3)
tmp <- full_join(tmp, tmp4)

# Get II
h_exp1 %>% 
  filter(num_pop == 50) %>% 
  gather(model, h, back_p:div_sub_p) %>% 
  filter(model %in% c("div_sub_p")) -> 
  tmp5

mi_exp1 %>% 
  filter(num_pop == 50) %>% 
  gather(model, mi, back_p:div_sub_p) %>% 
  filter(model %in% c("div_sub_p")) -> 
  tmp6

dmi_exp1 %>% 
  gather(model, dmi, back_p:div_sub_p) %>% 
  filter(model %in% c("div_sub_p")) -> 
  tmp7

pac_exp1 %>% 
  filter(num_pop == 50) %>% 
  gather(model, pac, back_p:div_sub_p) %>% 
  filter(model %in% c("div_sub_p")) -> 
  tmp8

tmp_ii <- full_join(tmp5, tmp6)
tmp_ii <- full_join(tmp_ii, tmp7)
tmp_ii <- full_join(tmp_ii, tmp8)


tmp$model <- revalue(tmp$model, c("mult_p"="EI", "add_p"="E", "sub_p"="I", "div_sub_p" == "II"))
tmp$model <- factor(tmp$model, levels=c("EI", "E", "I", "II"))

tmp %>% 
  ggplot(aes(x=pac, y=h, color=model)) +
  geom_point(size=0.1, alpha=0.5) +
  geom_hline(yintercept=0, color="dark grey") +
  labs(y="Entropy", x="PAC") +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(strip.text.y = element_text(angle = 0, face = "bold")) +
  facet_grid(model~., scales="free_y") ->
  p1
# plot(p1)

tmp %>% 
  ggplot(aes(x=pac, y=dmi, color=model)) +
  geom_point(size=0.1, alpha=0.5) +
  geom_hline(yintercept=0, color="dark grey") + 
  labs(y=expression(paste(Delta, "MI")), x="PAC") +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  theme(legend.position =  "none") +
  theme(strip.text.y = element_text(angle = 0, face = "bold")) +
  facet_grid(model~., scales="free_y") ->
  p2
# plot(p2)

(p1 / p2) + plot_layout(guides = 'collect') +
  plot_annotation(tag_levels = 'a', tag_suffix = ".")
  
ggsave("figures/pac.pdf", dpi=600)
```

```{r, fig.width=1.4, fig.height=3.1, echo=FALSE, warning=FALSE, message=FALSE}
bind_rows(tmp_ii,tmp) %>% 
  filter(model == "div_sub_p") %>% 
  ggplot(aes(x=pac, y=mi)) +
  geom_point(size=.5) +
  geom_hline(yintercept=0, color="dark grey") + 
  theme_classic() +
  facet_grid(q~.)
```
### Sig test results
```{r}
tmp %>% 
  filter(model=="E") ->
  ctmp
t1 <- cor.test(ctmp$pac, ctmp$dmi, method="spearman")
t1

tmp %>% 
  filter(model=="I") ->
  ctmp
t2 <- cor.test(ctmp$pac, ctmp$dmi, method="spearman")
t2

tmp %>% 
  filter(model=="EI") ->
  ctmp
t3 <- cor.test(ctmp$pac, ctmp$dmi, method="spearman")
t3
```


# Figure 4 - Div/sub intro
## Panel - FI arithmatic
```{r, fig.width=1.2, fig.height=1.85, echo=FALSE, warning=FALSE, message=FALSE}
phi1 <- function(x) {
  30 / (1 + exp(-.2*x + 5))
}

phi2 <- function(x, m, b) {
  x <- x - b
  x[x <= 0] <- 0
  x <- x * m
}

input = 1:100
fi = data.frame(
  ref=phi2(input, 1, 10), 
  sub=phi2(input-15, 1, 10), 
  div=phi2(input/1.5, 1, 10), 
  div_sub=phi2((input/1.5)-10, 1, 10))

fi %>% 
  ggplot(aes(x=input, y=sub)) +
  geom_line(color="black") +
  geom_line(data=fi, mapping=aes(x=input, y=ref), color="grey") +
  theme_classic() +
  geom_segment(aes(x = 66, xend = 86, y = 30, yend = 30),
                  lineend = "round", linejoin = "round",
                  size=.08,
                  arrow = arrow(length = unit(0.1, "cm"))) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) ->
  p1

fi %>% 
  ggplot(aes(x=input, y=div)) +
  geom_line(color="black") +
  geom_line(data=fi, mapping=aes(x=input, y=ref), color="grey") +
  theme_classic() + 
  labs(y="Output") +
  geom_curve(aes(x = 51, xend = 60, y = 40, yend = 34),
                  lineend = "round", linejoin = "round",
                  size = .06,
                  arrow = arrow(length = unit(0.1, "cm"))) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        #axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) -> 
  p2

fi %>% 
  ggplot(aes(x=input, y=div_sub)) +
  geom_line(color="black") +
  geom_line(data=fi, mapping=aes(x=input, y=ref), color="grey") +
  theme_classic() + 
  labs(x="Input") +
  geom_segment(aes(x = 32, xend = 52, y = 20, yend = 20),
                  lineend = "round", linejoin = "round",
                  size = 0.06,
                  arrow = arrow(length = unit(0.1, "cm"))) +
  geom_curve(aes(x = 54, xend = 75, y = 44, yend = 34),
                  lineend = "round", linejoin = "round",
                  size = .06,
                  arrow = arrow(length = unit(0.1, "cm"))) +
  theme(#axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) ->  
  p3

# Labels
p1_label <- as_ggplot(text_grob(TeX("I^{-}"), hjust=3))
p2_label <- as_ggplot(text_grob(TeX("I^{\\div}"), hjust=3))
p3_label <- as_ggplot(text_grob(TeX("II"), hjust=4))

# Build
p.fi <- plot((p1 + p1_label) /( p2 + p2_label) / (p3 + p3_label))
ggsave("figures/fi2.png", dpi=600)
```
## Panel - Examples
TODO - need timecourse plots for these below. Put them in a figure here aboure dMI. For intuition.


# Figure 5 - Div/Sub results
## Panel - timecourses
```{r, fig.width=3, fig.height=1, echo=FALSE, warning=FALSE, message=FALSE}
dmi_exp1 %>% 
  group_by(stim_rate, g, num_pop, q) %>%
  summarise(add_p=mean(add_p),
            back_p=mean(back_p),
            div_sub_p=mean(div_sub_p),
            mult_p=mean(mult_p),
            osc_p=mean(osc_p),
            stim_p=mean(stim_p),
            sub_p=mean(sub_p)) %>%
  ungroup() %>%
  gather(model, mi, add_p:sub_p) -> tmp

tmp %>% 
  filter(model %in% c("div_sub_p")) %>% 
  filter(num_pop == 50) %>% 
  ggplot(aes(x=stim_rate, y=mi, color=g, group=g)) +
  geom_line(size=0.5, alpha=0.9) +
  geom_point(size=0.7, alpha=1) +
  geom_hline(yintercept=0, color="dark grey") + xlab("") +
  lims(y=c(-.5, 0.75)) +
  labs(y=expression(paste(Delta, "MI")), 
       x="Stimulus firing rate", 
       title=TeX('Divisive fraction:')) +
  theme_classic() +
  theme(strip.background = element_blank()) +
  theme(legend.background = element_rect(colour ="black")) +
  theme(legend.key.size = unit(.3, "cm")) +
  facet_grid(.~q)
ggsave("figures/figure5.pdf", dpi=600)
```
